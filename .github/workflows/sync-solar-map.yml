# GitHub Action: Sync Solar Map Data
#
# This workflow:
# 1. Reads data from Google Sheets
# 2. Syncs images from Google Drive to ImageKit
# 3. Fetches images from ImageKit
# 4. Generates projects-data.json
# 5. Commits and pushes to GitHub Pages
#
# Triggers: Manual or scheduled (daily)

name: Sync Solar Map

on:
  # Manual trigger
  workflow_dispatch:

  # Scheduled: Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install googleapis node-fetch

      - name: Create sync script
        run: |
          cat > sync.js << 'ENDOFSCRIPT'
          const { google } = require('googleapis');
          const fs = require('fs');
          const https = require('https');

          // Configuration
          const SPREADSHEET_ID = '17Kh4gbJNhrd-2lp7rRPRJSDlBwpA5TU21oceIqV2cwY';
          const SHEET_NAME = 'External';
          const PHOTOS_FOLDER_ID = '19nAnSH9qthjjXOaODWVty67Tv6Q28pqO';
          const IMAGEKIT_PRIVATE_KEY = process.env.IMAGEKIT_PRIVATE_KEY;
          const IMAGEKIT_FOLDER = '/solar-map';

          // Column mapping (0-based)
          const COLS = {
            PROJECT_NUM: 0,
            ADDRESS: 1,
            OWNER: 2,
            CAPACITY: 3,
            YEAR: 4,
            PROGRAM: 5,
            PROJECT_TYPE: 6,
            CLIENT_TYPE: 7,
            MODULE: 8,
            RACKING: 9,
            INVERTER: 10,
            NOTES: 11,
            LAT: 12,
            LNG: 13
          };

          let auth;

          async function initAuth() {
            const credentials = JSON.parse(process.env.GOOGLE_CREDENTIALS);
            auth = new google.auth.GoogleAuth({
              credentials,
              scopes: [
                'https://www.googleapis.com/auth/spreadsheets.readonly',
                'https://www.googleapis.com/auth/drive.readonly'
              ]
            });
          }

          async function getSheetData() {
            const sheets = google.sheets({ version: 'v4', auth });
            const response = await sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: `${SHEET_NAME}!A:N`
            });
            return response.data.values || [];
          }

          async function getDriveFolders() {
            const drive = google.drive({ version: 'v3', auth });
            const response = await drive.files.list({
              q: `'${PHOTOS_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder'`,
              fields: 'files(id, name)',
              pageSize: 1000
            });
            return response.data.files || [];
          }

          async function getDriveFiles(folderId) {
            const drive = google.drive({ version: 'v3', auth });
            const response = await drive.files.list({
              q: `'${folderId}' in parents and mimeType contains 'image/'`,
              fields: 'files(id, name, mimeType, size)',
              pageSize: 1000
            });
            return response.data.files || [];
          }

          async function downloadDriveFile(fileId) {
            const drive = google.drive({ version: 'v3', auth });
            const response = await drive.files.get(
              { fileId, alt: 'media' },
              { responseType: 'arraybuffer' }
            );
            return Buffer.from(response.data);
          }

          function fetchImageKit() {
            return new Promise((resolve, reject) => {
              const authStr = Buffer.from(IMAGEKIT_PRIVATE_KEY + ':').toString('base64');
              const url = 'https://api.imagekit.io/v1/files?limit=1000&type=file';
              
              https.get(url, {
                headers: { 'Authorization': `Basic ${authStr}` }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    reject(e);
                  }
                });
              }).on('error', reject);
            });
          }

          function uploadToImageKit(base64Data, fileName, projectNum) {
            return new Promise((resolve, reject) => {
              const authStr = Buffer.from(IMAGEKIT_PRIVATE_KEY + ':').toString('base64');
              const folderPath = `${IMAGEKIT_FOLDER}/project-${projectNum}`;
              const sanitizedName = fileName.replace(/[^a-zA-Z0-9._-]/g, '_');

              const boundary = '----FormBoundary' + Math.random().toString(36).slice(2);
              
              let body = '';
              body += `--${boundary}\r\n`;
              body += `Content-Disposition: form-data; name="file"\r\n\r\n`;
              body += `${base64Data}\r\n`;
              body += `--${boundary}\r\n`;
              body += `Content-Disposition: form-data; name="fileName"\r\n\r\n`;
              body += `${sanitizedName}\r\n`;
              body += `--${boundary}\r\n`;
              body += `Content-Disposition: form-data; name="folder"\r\n\r\n`;
              body += `${folderPath}\r\n`;
              body += `--${boundary}\r\n`;
              body += `Content-Disposition: form-data; name="useUniqueFileName"\r\n\r\n`;
              body += `false\r\n`;
              body += `--${boundary}--\r\n`;

              const options = {
                hostname: 'upload.imagekit.io',
                path: '/api/v1/files/upload',
                method: 'POST',
                headers: {
                  'Authorization': `Basic ${authStr}`,
                  'Content-Type': `multipart/form-data; boundary=${boundary}`,
                  'Content-Length': Buffer.byteLength(body)
                }
              };

              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    const result = JSON.parse(data);
                    if (res.statusCode === 200) {
                      resolve(result);
                    } else {
                      reject(new Error(result.message || 'Upload failed'));
                    }
                  } catch (e) {
                    reject(e);
                  }
                });
              });
              req.on('error', reject);
              req.write(body);
              req.end();
            });
          }

          function extractProjectNum(str) {
            const match = str.match(/^(\d+)/);
            return match ? match[1] : null;
          }

          function extractProjectNumFromPath(filePath) {
            const match = filePath.match(/project-(\d+)/i);
            return match ? match[1] : null;
          }

          function buildImageUrls(file) {
            const baseUrl = file.url;
            return {
              name: file.name,
              url: baseUrl.replace('/solar-map/', '/solar-map/tr:q-auto,f-auto/'),
              thumbnail: baseUrl.replace('/solar-map/', '/solar-map/tr:w-300,h-200,c-at_max,q-auto,f-auto/'),
              fileId: file.fileId
            };
          }

          function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          async function syncDriveToImageKit() {
            console.log('\nüîÑ Syncing Drive ‚Üí ImageKit...');
            
            // Get existing ImageKit files
            const existingFiles = await fetchImageKit();
            const existingByProject = {};
            for (const file of existingFiles) {
              if (!file.filePath || !file.filePath.includes('/solar-map/')) continue;
              const projectNum = extractProjectNumFromPath(file.filePath);
              if (!projectNum) continue;
              if (!existingByProject[projectNum]) existingByProject[projectNum] = new Set();
              existingByProject[projectNum].add(file.name);
            }
            
            // Get Drive folders
            const folders = await getDriveFolders();
            console.log(`   Found ${folders.length} folders in Drive`);
            
            let uploaded = 0;
            let skipped = 0;
            
            for (const folder of folders) {
              const projectNum = extractProjectNum(folder.name);
              if (!projectNum) continue;
              
              const files = await getDriveFiles(folder.id);
              if (files.length === 0) continue;
              
              const existingNames = existingByProject[projectNum] || new Set();
              
              for (const file of files) {
                if (existingNames.has(file.name)) {
                  skipped++;
                  continue;
                }
                
                try {
                  console.log(`   üì§ Uploading: Project ${projectNum} - ${file.name}`);
                  const buffer = await downloadDriveFile(file.id);
                  const base64 = buffer.toString('base64');
                  await uploadToImageKit(base64, file.name, projectNum);
                  uploaded++;
                  await delay(200);
                } catch (err) {
                  console.log(`   ‚ùå Failed: ${file.name} - ${err.message}`);
                }
              }
            }
            
            console.log(`   ‚úÖ Uploaded: ${uploaded}, Skipped: ${skipped}`);
            return uploaded;
          }

          async function main() {
            await initAuth();
            
            console.log('üìä Fetching Google Sheets data...');
            const rows = await getSheetData();
            console.log(`   Found ${rows.length - 1} rows`);
            
            // Sync images from Drive to ImageKit
            await syncDriveToImageKit();
            
            // Wait a moment for ImageKit to process uploads
            await delay(2000);
            
            console.log('\nüì∏ Fetching ImageKit files...');
            const files = await fetchImageKit();
            console.log(`   Found ${files.length} files`);
            
            // Group images by project
            const imagesByProject = {};
            for (const file of files) {
              if (!file.filePath || !file.filePath.includes('/solar-map/')) continue;
              if (file.fileType !== 'image') continue;
              
              const projectNum = extractProjectNumFromPath(file.filePath);
              if (!projectNum) continue;
              
              if (!imagesByProject[projectNum]) {
                imagesByProject[projectNum] = [];
              }
              imagesByProject[projectNum].push(buildImageUrls(file));
            }
            
            // Build projects array
            const projects = [];
            for (let i = 1; i < rows.length; i++) {
              const row = rows[i];
              if (!row[COLS.PROJECT_NUM] && !row[COLS.ADDRESS]) continue;
              
              const address = String(row[COLS.ADDRESS] || '').trim();
              if (!address) continue;
              if (address.toLowerCase().includes('placeholder')) continue;
              
              const projectNum = String(row[COLS.PROJECT_NUM] || '');
              const lat = parseFloat(row[COLS.LAT]) || null;
              const lng = parseFloat(row[COLS.LNG]) || null;
              
              if (!lat || !lng) continue;
              
              projects.push({
                projectNum,
                address,
                owner: String(row[COLS.OWNER] || ''),
                capacity: parseFloat(row[COLS.CAPACITY]) || 0,
                year: parseInt(row[COLS.YEAR]) || new Date().getFullYear(),
                program: String(row[COLS.PROGRAM] || ''),
                projectType: String(row[COLS.PROJECT_TYPE] || ''),
                clientType: String(row[COLS.CLIENT_TYPE] || ''),
                module: String(row[COLS.MODULE] || ''),
                racking: String(row[COLS.RACKING] || ''),
                inverter: String(row[COLS.INVERTER] || ''),
                notes: String(row[COLS.NOTES] || ''),
                lat,
                lng,
                images: imagesByProject[projectNum] || []
              });
            }
            
            console.log(`\n‚úÖ Generated ${projects.length} projects`);
            
            // Save to file
            fs.writeFileSync('projects-data-test.json', JSON.stringify(projects, null, 2));
            console.log('üìÅ Saved projects-data-test.json');
          }

          main().catch(err => {
            console.error('‚ùå Error:', err.message);
            process.exit(1);
          });
          ENDOFSCRIPT

      - name: Run sync script
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          IMAGEKIT_PRIVATE_KEY: ${{ secrets.IMAGEKIT_PRIVATE_KEY }}
        run: node sync.js

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add projects-data-test.json
          git stash
          git pull --rebase origin main
          git stash pop || true
          git add projects-data-test.json
          git diff --staged --quiet || git commit -m "Auto-sync: Update projects data (test)"
          git push
