# GitHub Action: Sync Solar Map Data
#
# This workflow:
# 1. Reads data from Google Sheets
# 2. Fetches images from ImageKit
# 3. Generates projects-data.json
# 4. Commits and pushes to GitHub Pages
#
# Triggers: Manual or scheduled (daily)

name: Sync Solar Map

on:
  # Manual trigger
  workflow_dispatch:

  # Scheduled: Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install googleapis node-fetch

      - name: Create sync script
        run: |
          cat > sync.js << 'EOF'
          const { google } = require('googleapis');
          const fs = require('fs');
          const https = require('https');

          // Configuration
          const SPREADSHEET_ID = '17Kh4gbJNhrd-2lp7rRPRJSDlBwpA5TU21oceIqV2cwY';
          const SHEET_NAME = 'External';
          const IMAGEKIT_PRIVATE_KEY = process.env.IMAGEKIT_PRIVATE_KEY;
          const IMAGEKIT_FOLDER = '/solar-map';

          // Column mapping (0-based)
          const COLS = {
            PROJECT_NUM: 0,
            ADDRESS: 1,
            OWNER: 2,
            CAPACITY: 3,
            YEAR: 4,
            PROGRAM: 5,
            PROJECT_TYPE: 6,
            CLIENT_TYPE: 7,
            MODULE: 8,
            RACKING: 9,
            INVERTER: 10,
            NOTES: 11,
            LAT: 12,
            LNG: 13
          };

          async function getSheetData() {
            const credentials = JSON.parse(process.env.GOOGLE_CREDENTIALS);
            
            const auth = new google.auth.GoogleAuth({
              credentials,
              scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly']
            });
            
            const sheets = google.sheets({ version: 'v4', auth });
            
            const response = await sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: `${SHEET_NAME}!A:N`
            });
            
            return response.data.values || [];
          }

          function fetchImageKit() {
            return new Promise((resolve, reject) => {
              const auth = Buffer.from(IMAGEKIT_PRIVATE_KEY + ':').toString('base64');
              const url = 'https://api.imagekit.io/v1/files?limit=1000&type=file';
              
              https.get(url, {
                headers: { 'Authorization': `Basic ${auth}` }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    reject(e);
                  }
                });
              }).on('error', reject);
            });
          }

          function extractProjectNum(filePath) {
            const match = filePath.match(/project-(\d+)/i);
            return match ? match[1] : null;
          }

          function buildImageUrls(file) {
            const baseUrl = file.url;
            return {
              name: file.name,
              url: baseUrl.replace('/solar-map/', '/solar-map/tr:q-auto,f-auto/'),
              thumbnail: baseUrl.replace('/solar-map/', '/solar-map/tr:w-300,h-200,c-at_max,q-auto,f-auto/'),
              fileId: file.fileId
            };
          }

          async function main() {
            console.log('üìä Fetching Google Sheets data...');
            const rows = await getSheetData();
            console.log(`   Found ${rows.length - 1} rows`);
            
            console.log('üì∏ Fetching ImageKit files...');
            const files = await fetchImageKit();
            console.log(`   Found ${files.length} files`);
            
            // Group images by project
            const imagesByProject = {};
            for (const file of files) {
              if (!file.filePath || !file.filePath.includes('/solar-map/')) continue;
              if (file.fileType !== 'image') continue;
              
              const projectNum = extractProjectNum(file.filePath);
              if (!projectNum) continue;
              
              if (!imagesByProject[projectNum]) {
                imagesByProject[projectNum] = [];
              }
              imagesByProject[projectNum].push(buildImageUrls(file));
            }
            
            // Build projects array
            const projects = [];
            for (let i = 1; i < rows.length; i++) {
              const row = rows[i];
              if (!row[COLS.PROJECT_NUM] && !row[COLS.ADDRESS]) continue;
              
              const address = String(row[COLS.ADDRESS] || '').trim();
              if (!address) continue;
              if (address.toLowerCase().includes('placeholder')) continue;
              
              const projectNum = String(row[COLS.PROJECT_NUM] || '');
              const lat = parseFloat(row[COLS.LAT]) || null;
              const lng = parseFloat(row[COLS.LNG]) || null;
              
              if (!lat || !lng) continue;
              
              projects.push({
                projectNum,
                address,
                owner: String(row[COLS.OWNER] || ''),
                capacity: parseFloat(row[COLS.CAPACITY]) || 0,
                year: parseInt(row[COLS.YEAR]) || new Date().getFullYear(),
                program: String(row[COLS.PROGRAM] || ''),
                projectType: String(row[COLS.PROJECT_TYPE] || ''),
                clientType: String(row[COLS.CLIENT_TYPE] || ''),
                module: String(row[COLS.MODULE] || ''),
                racking: String(row[COLS.RACKING] || ''),
                inverter: String(row[COLS.INVERTER] || ''),
                notes: String(row[COLS.NOTES] || ''),
                lat,
                lng,
                images: imagesByProject[projectNum] || []
              });
            }
            
            console.log(`‚úÖ Generated ${projects.length} projects`);
            
            // Save to file
            fs.writeFileSync('projects-data-test.json', JSON.stringify(projects, null, 2));
            console.log('üìÅ Saved projects-data-test.json');
          }

          main().catch(err => {
            console.error('‚ùå Error:', err.message);
            process.exit(1);
          });
          EOF

      - name: Run sync script
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          IMAGEKIT_PRIVATE_KEY: ${{ secrets.IMAGEKIT_PRIVATE_KEY }}
        run: node sync.js

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add projects-data-test.json
          git diff --staged --quiet || git commit -m "Auto-sync: Update projects data (test)"
          git push
